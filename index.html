<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NM Induction Log</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5ed7"/>
  <style>
    :root { --bg:#f7f7f7; --primary:#0b5ed7; --text:#111; --muted:#666; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { background:var(--primary); color:#fff; padding:16px 20px; position:sticky; top:0; }
    h1 { margin:0; font-size:20px; }
    main { max-width:720px; margin:0 auto; padding:16px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:16px; }
    label { display:block; font-weight:600; margin:6px 0; }
    input { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px; }
    button { width:100%; padding:12px; margin-top:12px; border:none; border-radius:10px; background:var(--primary); color:#fff; font-weight:600; font-size:16px; }
    button:disabled { opacity:.7; }
    .muted { color:var(--muted); font-size:12px; margin-top:8px; }
    .result { margin-top:16px; }
    table { width:100%; border-collapse:collapse; font-size:15px; }
    td { padding:10px 6px; border-bottom:1px solid #eee; vertical-align:top; }
    td:first-child { width:45%; font-weight:600; color:#333; }
    .not-found { color:#b00020; font-weight:700; margin-top:8px; }
    .chip { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .chip.ok { background:#e7f7ec; color:#127a3a; }
    .chip.no { background:#fde7ea; color:#a5122a; }
    .top-status { display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <h1>SAJCO Induction Log - NM</h1>
  </header>
  <main>
    <div class="card">
      <label for="q">EMP # / Iqama #</label>
      <input id="q" inputmode="numeric" placeholder="e.g. 2461372647" autocomplete="off" />
      <button id="go">Search</button>
      <div id="msg" class="muted">Only the required fields are shown.</div>
      <div id="res" class="result"></div>
    </div>
  </main>

<script src="config.js"></script>
<script>
  // 1) See what URL we have from config.js
  console.log("API_URL from config.js =", window.API_URL);

  // 2) Fallback (PUT YOUR REAL /exec HERE so it always has a value)
  window.API_URL = window.API_URL || "https://script.google.com/macros/s/AKfycbxCRxdauakVUvMeiZfzwBUeAQi0byA53HoVs6ukqXdUMvfH6whNxGtjT42O2arYRY8w/exec";

  // 3) Disable SW while debugging (avoid cached old JS)
  // if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-workerv2.js');

  const btn  = document.getElementById('go');
  const input= document.getElementById('q');
  const res  = document.getElementById('res');
  const msg  = document.getElementById('msg');

  function search() {
    const q = (input.value || '').trim();
    res.innerHTML = "";
    if (!q) { msg.textContent = "Enter EMP # / Iqama #"; return; }
    btn.disabled = true; msg.textContent = "Searching...";

    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
    const src = window.API_URL + "?q=" + encodeURIComponent(q) + "&callback=" + cb;
    console.log("JSONP request:", src);

    window[cb] = (data) => {
      try {
        console.log("JSONP response:", data);
        if (!data || !data.found) {
          res.innerHTML = '<div class="not-found">No induction record found.</div>';
          msg.textContent = "Not found";
          return;
        }
        const w = data.worker || {};
        const pledge = (w["Defensive Driving Briefing and Pledge"] || "").toLowerCase();
        const pledgeOk = pledge === "yes" || pledge === "conducted";
        const waterOk  = (w["Water Flask availability"] || "").toLowerCase() === "yes";

        res.innerHTML = `
          <div class="top-status">
            <span class="chip ${w["Date of Induction"] ? 'ok' : 'no'}">${w["Date of Induction"] ? 'Inducted' : 'Not Inducted'}</span>
            <span class="chip ${pledgeOk ? 'ok' : 'no'}">Defensive Driving</span>
            <span class="chip ${waterOk ? 'ok' : 'no'}">Water Flask</span>
          </div>
          <table>
            <tr><td>EMP # / Iqama #</td><td>${w["EMP # / Iqama #"] ?? ""}</td></tr>
            <tr><td>Employee Name</td><td>${w["Employee Name"] ?? ""}</td></tr>
            <tr><td>Designation / Job</td><td>${w["Designation / Job"] ?? ""}</td></tr>
            <tr><td>Company</td><td>${w["Company"] ?? ""}</td></tr>
            <tr><td>Date of Induction</td><td>${w["Date of Induction"] ?? ""}</td></tr>
            <tr><td>Inducted by</td><td>${w["Inducted by"] ?? ""}</td></tr>
            <tr><td>Project</td><td>${w["Project"] ?? ""}</td></tr>
            <tr><td>Defensive Driving Briefing and Pledge</td><td>${w["Defensive Driving Briefing and Pledge"] ?? ""}</td></tr>
            <tr><td>Water Flask availability</td><td>${w["Water Flask availability"] ?? ""}</td></tr>
            <tr><td>Medical Screening Status</td><td>${w["Medical Screening Status"] ?? ""}</td></tr>
          </table>
        `;
        msg.textContent = "Done";
      } finally {
        delete window[cb];
        if (script && script.parentNode) script.parentNode.removeChild(script);
        btn.disabled = false;
      }
    };

    const script = document.createElement('script');
    script.src = src;
    script.onerror = () => {
      console.error("JSONP script failed to load:", src);
      res.innerHTML = '<div class="not-found">Error: Failed to reach API</div>';
      msg.textContent = "Error";
      delete window[cb];
      btn.disabled = false;
    };
    document.body.appendChild(script);
  }

  btn.addEventListener('click', search);
  input.addEventListener('keyup', (e) => { if (e.key === 'Enter') search(); });
</script>




</body>
</html>
